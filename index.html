<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AGES</title>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>
    <!-- <link rel="stylesheet" href="style.css"> -->
    <style>
        .loader {
            border: 16px solid #f3f3f3; /* Light grey */
            border-top: 16px solid orange; /* Blue */
            border-radius: 50%;
            width: 120px;
            height: 120px;
            animation: spin 2s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .resident input[type="text"] {
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 5px;
            width: 60%;
        }
        .date-container input[type="text"] {
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 5px;
            width: 100%;
        }
        select {
            padding: 5px;
            font-size: 16px;
            width: 100%;
            color: black;
            border: 2px solid #dbdbdb;
            border-radius: 8px;
        }
        .search-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 10px;
            margin-top:10px;
        }
        
        .flex {
            display: flex;
        }
        
        .search-bar label {
            font-size: 16px;
            color: #555;
            /* margin-right: 10px; */
        }
        .date-container {
            display: flex;
            width: 100%;
            align-items: center;
        }
        p span{
            text-transform: uppercase;
        }
        h4 {
            margin-bottom: 15px;
            font-size: 18px;
            color: #333;
            border-bottom: 1px solid #d0d0d0;
            padding-bottom: 5px;
        }
        /* Vehicle Row Styling */
        .vehicle-row {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }
        
        .vehicle-row .info {
            flex-basis: 48%;
        }
        body {
            font-family: Arial, sans-serif;
            background-color: #f2f2f2;
            margin: 0;
            padding: 0;
        }
        
        .navbar-title{
            font-weight: bold;
        }
        
        .burger{
            background: none;
            border: none;
            color: orange;
        }
        
        .profile{
            background: none;
            border: none;
            color: orange;
        }
        
        .status-icons{
            justify-items: center;
        }
        /* Navbar Styles */
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #c6ec8d;
            padding: 10px;
        }
        
        .navbar-item img {
            width: 24px;
            height: 24px;
        }
        
        .navbar-title {
            font-size: 20px;
            color: black;
        }
        
        /* Container Styles */
        .container {
            max-width: 400px;
            margin: 20px auto;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #c6ec8d;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        
        .header h1 {
            margin: 0;
            font-size: 20px;
            color: black;
        }
        
        .menu-btn, .search-btn {
            background: none;
            border: none;
            cursor: pointer;
            width: 20px;
            height: 20px;
        }
        
        .image-box {
            width: 100%;
            height: 200px;
            background-color: #e0e0e0;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 10px;
        }
        
        .image-box img {
            max-width: 100%;
            max-height: 100%;
            border-radius: 10px;
        }
        
        .toggle-view{
            background-color: lightgray;
            border: none;
            padding: 10px;
            font: inherit;
            border-radius: 10px;
        }
        
        .toggle-view:active {
            background-color: gray;
        }
        
        .alert-cont {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 95%;
            padding: 0px 10px 10px 10px;
        }
        
        .alert-box {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            background-color: none;
            border: 3px solid lightgray;
            color: #b30000;
            font-weight: bolder;
            padding: 10px 0px 0px 0px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .alert{
            display: flex;
        }
        .alert-box p {
            margin: 0;
            font-size: 14px;
            padding-left: 10px;
        }
        
        .hidden {
            display: none !important;
        }
        
        .toggle-view {
            margin-bottom: 10px;
        }
        
        .toggle-view:hover {
            background-color: darkgray;
        }
        
        .close-alert {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #b30000;
        }
        
        .status-info {
            margin-bottom: 15px;
            border: 3px solid lightgray;
            border-radius: 8px;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            /* margin: 5px 0; */
            align-items: center;
            padding: 10px;
        }
        
        .info-row2 {
            display: flex;
            justify-content: space-between;
            /* margin: 5px 0; */
            padding: 10px;
            background-color: lightgray;
        }
        
        .info-row-top {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background-color: lightgray;
        }
        
        .info-row3{
            display: flex;
            justify-content: space-between;
            /* margin: 5px 0; */
            padding: 10px;
            background-color: lightgray;
        }
        .info-label {
            font-weight: bold;
            color: #555;
        }
        
        .info-value {
            color: #555;
        }
        
        .error-message {
            background-color: #f9f9f9;
            margin-top: 10px;
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 2.5px solid #dadada;
        }
        
        .error-message span {
            color: #d9534f;
            margin-right: auto;
            margin-left: 8px;
            font-weight: bold;
            font-size: 14px;
        }
        
        .close-error {
            border: 0px;
            font-weight: bold;
            background-color: #f9f9f9;
        }
        
        .status-icons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap:10px;
            /* gap: 10px; */
            /* margin-bottom: 15px; */
        }
        
        .form-field {
            display: flex;
            flex-direction: column;
            width: 100%;
        }
        
        .form-field h3{
            text-align: left;
            font-size: 15px;
        }
        
        .icon-box {
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 10px;
            cursor: pointer;
        }
        .form-group {
            margin-bottom: 15px;
            font-weight: bold;
        }
        
        .id-image {
            width: 100%;
            height: 150px;
            background-color: #e0e0e0;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 14px;
            color: #666666;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-top: 10px;
            margin-bottom: 10px;
        }
        
        .form-group-horizontal {
            display: flex;
            align-items: center;
        }
        
        .form-group-horizontal label {
            font-size: 15px;
            font-weight: bold;
            width: 30%;
            
        }
        
        .form-group-horizontal input[type="number"] {
            width: 72%;
            padding: 8px;
            font-size: 14px;
            border: 2px solid #dadada;
            border-radius: 8px;
            margin: 0 0 10px 0;
        }
        
        .form-group-vehicle {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 10px;
        }
        .icon-box.green {
            background-color: #ccffcc;
            height: 80px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        
        .icon-label-online{
            margin-top: 10px;
            font-size: 12px; 
            color: #000; 
            font-weight: bold;
        }
        
        .icon-label-scanner{
            margin-top: 10px;
            font-size: 12px; 
            color: #000; 
            font-weight: bold;
        }
        
        .icon-label-camol{
            margin-top: 10px;
            font-size: 12px; 
            color: #000; 
            font-weight: bold;
        }
        
        .icon-label-sensor{
            margin-top: 10px;
            font-size: 12px; 
            color: #000; 
            font-weight: bold;
        }
        
        .icon-box.red {
            background-color: #ffcccc;
            height: 80px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        
        .icon-label-gate{
            margin-top: 10px;
            font-size: 12px; 
            color: #000; 
            font-weight: bold;
        }
        
        .icon-label-obs{
            margin-top: 10px;
            font-size: 12px; 
            color: #000; 
            font-weight: bold;
        }
        
        .icon-box.yellow {
            background-color: #ffffcc;
            height: 80px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        
        .icon-label-temp{
            margin-top: 10px;
            font-size: 12px; 
            color: #000; 
            font-weight: bold;
        }
        
        .icon-label-visitor{
            margin-top: 0px;
            font-size: 12px; 
            color: #000; 
            font-weight: bold;
        }
        
        .icon-label-signal{
            margin-top: 10px;
            font-size: 12px; 
            color: #000; 
            font-weight: bold;
        }
        
        .icon-box img {
            max-width: 30px;
            max-height: 30px;
        }
        
        .icon-box:hover {
            transform: scale(1.2);
            transition: transform 0.2s;
        }
        
        .driver-info {
            margin: 10px 0;
            border: 3px solid lightgray;
            border-radius: 8px;
        }
        
        .driver-info .info-row {
            display: flex;
            justify-content: space-between;
            /* margin: 5px 0; */
        }
        
        #progress-container {
            width: 100%;
            height: 10px;
            background-color: #b30000; /* Background color of the container */
            position: relative;
            overflow: hidden;
        }
        
        #progress-bar {
            width: 100%;
            height: 100%;
            background-color: #ddd; /* Progress bar color */
            position: absolute;
            right: 0; /* Align to the right side */
            transition: width 5s linear; /* Smooth transition over 5 seconds */
        }
    </style>
</head>
<body onload="process()">
    <!-- Main Container -->
    <div class="container main" id="container-main">
        
            <div class="image-box">
                <img src="hillcrest.webp" alt="Gate Image">
                <!-- <iframe src="http://192.168.1.54" width="100%" height="600" id="myIframe" frameborder="0" allowfullscreen></iframe> -->
            </div>
            
            <div class="driver-info">
                <div class="info-row">
                    <div class="info-label">Last Detected Driver Details</div>
                </div>
                <div id="LastDriverElement" class="flex" style="flex-direction: column;">
                    <div class="info-row2">
                        <div class="info-label">Name</div>
                        <div id="current-driver-name" class="info-value">Dela Cruz, Juan</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Plate Number</div>
                        <div id="current-driver-plate" class="info-value">ABC123</div>
                    </div>
                    <div class="info-row3">
                        <div class="info-label">Entry Info</div>
                        <div id="current-driver-date" class="info-value">hh:mm:ss | yyyy mm dd</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Street</div>
                        <div id="current-driver-street" class="info-value">Molave Street</div>
                    </div>
                </div>
                
                <div id="LastDriverLoader" class="hidden" style="justify-content: center; width: 80%; padding: 10%;">
                    <div class="loader" id="loader" style="height:120px;">
                    </div>
                </div>
                
            </div>
            
            <div id="alert-box" class="alert-box hidden">
                <div class="alert-cont">
                    <div class="alert">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-exclamation-circle-fill" viewBox="0 0 16 16">
                            <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0M8 4a.905.905 0 0 0-.9.995l.35 3.507a.552.552 0 0 0 1.1 0l.35-3.507A.905.905 0 0 0 8 4m.002 6a1 1 0 1 0 0 2 1 1 0 0 0 0-2"/>
                        </svg>
                        <p>Error!</p>
                    </div>
                    <button id="close-alert" class="close-alert">âœ•</button>
                </div>
                <div id="progress-container">
                    <div id="progress-bar"></div>
                </div>
            </div>
            
            <button id="viewLogsButton" class="toggle-view" onclick="window.location.href='pages/logs.html'">View Logs</button>
            
            <button id="manageResidentsButton" class="toggle-view" style="display:none" onclick="window.location.href='pages/vehicle.html'">Manage Vehicles</button>
            
            <button id="manageVehiclesButton" class="toggle-view" style="display:none" onclick="window.location.href='pages/resident.html'">Manage Residents</button>
            
            <div class="visitor-list-container" style="
                background-color: lightgray;
                border: 3px solid lightgray; 
                border-radius: 10px; 
                margin: 0 0 10px 0; 
                max-height: 200px; 
                overflow: hidden; 
                padding: 10px 5px 5px 5px;
                ">
            <header style="font-size: 20px; margin: 0 0 10px 10px; background-color: lightgray; font-weight: bold; color: #555;">Visitor List</header>
                <div style="
                    max-height: 150px; 
                    overflow-y: auto; 
                    padding-right: 10px;
                    ">
                        <style>
                            /* Scrollbar styles for WebKit browsers */
                            ::-webkit-scrollbar {width: 5px;}
                            ::-webkit-scrollbar-thumb {background-color: #888; border-radius: 6px;}
                            ::-webkit-scrollbar-thumb:hover {background-color: #555;}
                            ::-webkit-scrollbar-track {background: #f1f1f1; border-radius: 6px;}
                            ul {list-style: none; padding: 0; margin: 0;}
                            li {padding: 10px; background-color: white; color: #555; border: 1px solid lightgray;}
                            li:hover { background-color: #ccc; }
                        </style>
                    <ul id="visitlist">
                
                    </ul>
                </div>
            </div>
    <div id="status-icons" class="status-icons">
        <div id="gate-position" class="icon-box red icon-clickable">
            <svg id="svgGatePosition" xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-door-open-fill" viewBox="0 0 16 16">
                <path d="M1.5 15a.5.5 0 0 0 0 1h13a.5.5 0 0 0 0-1H13V2.5A1.5 1.5 0 0 0 11.5 1H11V.5a.5.5 0 0 0-.57-.495l-7 1A.5.5 0 0 0 3 1.5V15zM11 2h.5a.5.5 0 0 1 .5.5V15h-1zm-2.5 8c-.276 0-.5-.448-.5-1s.224-1 .5-1 .5.448.5 1-.224 1-.5 1"/>
            </svg>
            <div id="icon-label-gate" class="icon-label-gate">Closed</div>
        </div>
        <div id="gate-obstacle" class="icon-box red">
            <svg id="svgGateObstacle" xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-slash-circle" viewBox="0 0 16 16">
                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                <path d="M11.354 4.646a.5.5 0 0 0-.708 0l-6 6a.5.5 0 0 0 .708.708l6-6a.5.5 0 0 0 0-.708"/>
            </svg>
            <div id="icon-label-obs" class="icon-label-obs">Blocked</div>
        </div>
        <div id="gate-visitor" class="icon-box green" onclick="modalOpen('visitorModal')">
            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="currentColor" class="bi bi-person-fill-add" viewBox="0 0 16 20">
                <path d="M12.5 16a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7m.5-5v1h1a.5.5 0 0 1 0 1h-1v1a.5.5 0 0 1-1 0v-1h-1a.5.5 0 0 1 0-1h1v-1a.5.5 0 0 1 1 0m-2-6a3 3 0 1 1-6 0 3 3 0 0 1 6 0"/>
                <path d="M2 13c0 1 1 1 1 1h5.256A4.5 4.5 0 0 1 8 12.5a4.5 4.5 0 0 1 1.544-3.393Q8.844 9.002 8 9c-5 0-6 3-6 4"/>
            </svg>
            <div id="icon-label-visitor" class="icon-label-visitor">Add Visitor</div>
        </div>
    </div>
    <button class="LoginAsAdmin" id="LoginAsAdmin" onclick="openAdminLoginModal()" style="display:flex; width:100%; padding: 10px; background-color: gray; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px;">Login as admin?</button>
</div>
<div class="container" id="container-visitorModal" style="display:none;position:relative;background-color: white;width: 90%;max-width: 400px;padding: 20px;border-radius: 8px;box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);">
    <div class="vheader" style="display: flex;justify-content: space-between;align-items: center;font-weight: bold;margin: 0 0 10px 0;">
        <h3 style="margin: 0px !important;font-size: 26px;text-align: center;">Add Visitor</h3>
        <button id="viewLogsButton" style="background-color: gray;color: white;border: none;border-radius: 5px;cursor: pointer;padding: 8px 8px 7px 8px;font-size: 14px;height: 25%;margin: 0 0 0 0;"
        class="toggle-view-Back" onclick="window.location.href='/'">x</button>
    </div>

    <div class="form-group-horizontal">
        <label for="visitor-number">Visitor #</label>
        <input type="number" id="visitor-number" placeholder="#" value="">
    </div>
    <!-- <div class="error-message">
        <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 32 32" id="error">
            <path fill="red" d="M16 32c8.836 0 16-7.164 16-16S24.836 0 16 0 0 7.164 0 16s7.164 16 16 16zm2-14a2 2 0 0 1-4 0V8a2 2 0 0 1 4 0v10zm-2 3.968a2 2 0 1 1-.001 4.001A2 2 0 0 1 16 21.968z"></path>
        </svg>
        <span>Visitor # already used</span>
        <button class="close-error">X</button>
    </div> -->

    <div class="form-group">
        <label for="id-image">I.D. Image</label>
        <div class="id-image">
            <input type="image" id="visitorimage">
        </div>
    </div>

    <div class="form-group-vehicle" style="display: flex;justify-content: space-between;gap: 20px;margin-bottom: 10px;">
        <div class="form-field">
            <h3 style="margin: 0px !important;">Vehicle Type</h3>
            <select id="vehicle-type">
                <option value="sedan">Sedan</option>
                <option value="suv">SUV</option>
                <option value="truck">Truck</option>
                <option value="motorcycle">Motorcycle</option>
            </select>
        </div>

        <div class="form-field">
            <h3 style="margin: 0px !important;">Vehicle Brand</h3>
            <select id="vehicle-brand">
                <option value="toyota">Toyota</option>
                <option value="honda">Honda</option>
                <option value="ford">Ford</option>
                <option value="nissan">Nissan</option>
            </select>
        </div>
    </div>

    <style>
        .add-visitor-btn:hover{
            background-color: rgb(100,100,100) !important;
        }
    </style>
    <button class="add-visitor-btn" onclick="addVisitor()"style="width: 100%;margin-top: 8px;padding: 10px;background-color: lightgray;border: none;font-size: 16px;border-radius: 8px;color: black;font-weight: bold;cursor: pointer;">Add Visitor</button>
</div>
<div id="visitorInfoModal" style="display:none; margin:0; position:fixed; flex-direction: column; top:50%; left:50%; transform: translate(-50%,-50%); padding:20px; max-width: 90%; max-height: 80%; width: 400px; height: auto; border-radius: 8px; background-color: white; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); overflow-y: auto;">
    <div id="InfoVisitorHeader" class="InfoVisitorHeader" style="justify-content: space-between; align-items: center; display: flex;">
        <h3 style="margin:0;">Visitor Information</h3>
        <button onclick="closeVisitorInfoModal()" style="padding: 10px; background-color: gray; color: white; border: none; border-radius: 5px; cursor: pointer;">X</button>  
    </div>
    <p><strong>Visitor ID: </strong><span id="modal-visitorid"></span></p>
    <p><strong>Entry Date: </strong><span id="modal-visitorentry"></span></p>
    <p><strong>Exit Date: </strong><span id="modal-visitorexit"></span></p>
    <p><strong>Vehicle Brand: </strong><span id="modal-visitorvbrand"></span></p>
    <p><strong>Vehicle Type: </strong><span id="modal-visitorvtype"></span></p>
    <p><strong>Visitor ID Image: </strong><span id="modal-visitorimage"></span></p>
    <div class="form-group" style="margin-bottom: 0 !important;">
        <div class="id-image" style="height: 200px !important;"></div>
    </div>
    <button id="deleteVisitorBtn" onclick="deleteVisitor()" style="padding: 10px; background-color: red; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px;">Delete Visitor</button>    
</div>


<div id="adminLoginModal" style="display: none;position: fixed;width: 300px;top: 50%;left: 50%;transform: translate(-50%,-50%);background-color: white;padding: 20px;border-radius: 8px;box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);flex-direction: column;">
    <div class="LoginHeader" style="display: flex;position: relative;justify-content: space-between;align-items: center;margin-bottom: 20px;">
        <h3 style="margin: 0 !important;">Admin Login</h3>
        <button onclick="closeAdminLoginModal()" style="padding: 10px; background-color: gray; color: white; border: none; border-radius: 5px; cursor: pointer;">X</button>
    </div>
    <input type="text" id="username" placeholder="Enter username" required style="width: 280px;padding: 8px;font-size: 14px;border: 2px solid #dadada;border-radius: 8px;margin: 0 0 10px 0;">
    <input type="password" id="password" placeholder="Enter password" required style="width: 280px;padding: 8px;font-size: 14px;border: 2px solid #dadada;border-radius: 8px;margin: 0 0 10px 0;">
    <button id="AdminLoginBtn" onclick="adminLogin()" style="width:20%; padding: 10px; background-color: gray; color: white; border: none; border-radius: 5px; cursor: pointer;">Login</button>
</div>

</body>

<script>
    function searchResidents() {
        const searchValue = document.getElementById('searchBar').value.trim().toLowerCase();
        
        // Ensure search value is not empty
        if (searchValue === "") {
            alert("Please enter a search term.");
            return;
        }
        
        const residentsRef = db.collection('Residents');
        
        // Fetch all residents and perform the search locally
        residentsRef
        .get()
        .then((querySnapshot) => {
            const residentSelect = document.getElementById('resident');
            
            // Clear previous options
            residentSelect.innerHTML = '<option value="na" disabled selected>Search Resident First</option>';
            
            let found = false;
            
            // Loop through the query results
            querySnapshot.forEach((doc) => {
                const resident = doc.data();
                
                // Concatenate the full name fields
                const fullName = `${resident.firstName.toLowerCase()} ${resident.MiddleName ? resident.MiddleName.toLowerCase() + ' ' : ''}${resident.lastName.toLowerCase()}`;
                
                // Check if the full name matches the search value (partial matching)
                if (fullName.startsWith(searchValue)) {
                    found = true;
                    
                    // Add an option for each matching resident
                    const option = document.createElement('option');
                    option.value = doc.id; // Use resident document ID as the value
                    option.textContent = `${resident.firstName} ${resident.MiddleName || ''} ${resident.lastName}`.trim(); // Display full name
                    
                    // Append the option to the select field
                    residentSelect.appendChild(option);
                }
            });
            
            // Handle case when no residents match
            if (!found) {
                const noOption = document.createElement('option');
                noOption.value = "na";
                noOption.textContent = "No residents found";
                residentSelect.appendChild(noOption);
            }
        })
        .catch((error) => {
            console.error("Error searching residents: ", error);
        });
    }
</script>

<script type = "text/javascript">
    var xmlHttp = createXmlHttpObject();
    
    function createXmlHttpObject() {
        if(window.XMLHttpRequest) {
            xmlHttp = new XMLHttpRequest();
        } else {
            xmlHttp = new ActiveXObject("Microsoft.XMLHTTP");
        }
        return xmlHttp;
    }
    
    function response() {
        var message;
        var currentSensor;
        var xmlResponse;
        var xmldoc;
        
        //get xml stream
        xmlResponse = xmlHttp.responseXML;
        
        if (xmlResponse != null) {
            
            xmldoc = xmlResponse.getElementsByTagName("SD");
            message = xmldoc[0].firstChild.nodeValue;
            
            if (message > 10) {
                document.getElementById("gate-obstacle").classList.add("green");
                document.getElementById("gate-obstacle").classList.remove("red");
                document.getElementById("icon-label-obs").innerHTML = "Clear";
                document.getElementById("info-label-obs").innerHTML = "Clear";
                changeSVG(svg_obsOpen, "svgGateObstacle", "gate-obstacle");
            } else {
                document.getElementById("gate-obstacle").classList.add("red");
                document.getElementById("gate-obstacle").classList.remove("green");
                document.getElementById("icon-label-obs").innerHTML = "Blocked";
                document.getElementById("info-label-obs").innerHTML = "Blocked";
                changeSVG(svg_obsClose, "svgGateObstacle", "gate-obstacle");
            }
            
            // document.getElementById("icon-label-obs").innerHTML = message;
            
            xmldoc = xmlResponse.getElementsByTagName("GPOS");
            message = xmldoc[0].firstChild.nodeValue;
            
            console.log(`gateMessage: ` + message);
            
            if (message == "0") {
                document.getElementById("gate-position").classList.add("green");
                document.getElementById("gate-position").classList.remove("red");
                document.getElementById("gate-position").classList.remove("yellow");
                document.getElementById("icon-label-gate").innerHTML = "Closed";
                document.getElementById("info-label-gate").innerHTML = "Closed";
                changeSVG(svg_gateClose, "svgGatePosition", "gate-position");
                
                xmldoc = xmlResponse.getElementsByTagName("RFID");
                
                if (xmldoc.length > 0 && xmldoc[0].firstChild != null && xmldoc[0].firstChild.nodeValue != null) {
                    message = xmldoc[0].firstChild.nodeValue;
                    console.log(message);
                    checkRFID(message).then(isFound => {
                        if (isFound) {
                            processGatePosition("1");   
                            // Wait 3 seconds for the icon-label-obs innerHTML to be 'blocked'
                            setTimeout(() => {
                                // Check if the innerHTML is 'blocked' after 3 seconds
                                const element = document.getElementById('icon-label-obs');
                                if (element && element.innerHTML === "Blocked") {
                                    // Close the gate after 3 seconds
                                    processGatePosition("0"); 
                                } else {
                                    processGatePosition("0"); 
                                }
                            }, 3000);  // 3000 milliseconds = 3 seconds
                        } else {
                            if (document.getElementById('container-waitrfid').style.display === 'flex') {
                                console.log(message);
                                document.getElementById('addvehiclerfid').value = message;
                                modalOpen('addVehicle');
                            }
                        }
                    });
                    // if (message == " 53 49 43 34") {
                    //     processGatePosition("1");
                    // }
                }
                
                
            } else if (message == "1") {
                document.getElementById("gate-position").classList.add("red");
                document.getElementById("gate-position").classList.remove("green");
                document.getElementById("gate-position").classList.remove("yellow");
                document.getElementById("icon-label-gate").innerHTML = "Open";
                document.getElementById("info-label-gate").innerHTML = "Open";
                changeSVG(svg_gateOpen, "svgGatePosition", "gate-position");
            } else if (message == "2") {
                document.getElementById("gate-position").classList.add("yellow");
                document.getElementById("gate-position").classList.remove("green");
                document.getElementById("gate-position").classList.remove("red");
                document.getElementById("icon-label-gate").innerHTML = "Rotating";
                document.getElementById("info-label-gate").innerHTML = "Rotating";
                changeSVG(svg_gateOpen, "svgGatePosition", "gate-position");
            }
        }
    }
    
    function process(){
        if(xmlHttp.readyState==0 || xmlHttp.readyState==4) {
            xmlHttp.open("PUT","xml",true);
            xmlHttp.onreadystatechange=response;
            xmlHttp.send(null);
        }       
        setTimeout("process()",1000);
    }
    
    function processGatePosition(value, retries = 3) {
        var xhttp = new XMLHttpRequest();
        xhttp.open("PUT", "/gateposition?position=" + value, true);  // Send value as a query parameter
        xhttp.onload = function() {
            if (xhttp.status >= 200 && xhttp.status < 300) {
                console.log('Success:', xhttp.responseText);
            } else {
                console.error('Error:', xhttp.statusText);
                if (retries > 0) {
                    console.log(`Retrying... Attempts left: ${retries}`);
                    processGatePosition(value, retries - 1); // Retry the request
                } else {
                    console.error('Max retries reached. Request failed.');
                }
            }
        };
        xhttp.send();
    }
    
    function modalOpen(type) {
        const contMain = document.getElementById('container-main');
        const contVisitor = document.getElementById('container-visitorModal')
        if (type == 'addResident') {
            contMain.style.display = "none";
            contVisitor.style.display = "none";
        } else if (type == 'addVehicle') {
            contMain.style.display = "none";
            contVisitor.style.display = "none";
        } else if (type == 'main') {
            contMain.style.display = "flex";
            contVisitor.style.display = "none";
        } else if (type == 'waitRFID') {
            contMain.style.display = "none";
            contVisitor.style.display = "none";
        } else if (type == 'visitorModal') {
            contMain.style.display = "none";
            contVisitor.style.display = "flex";
        }
        
    }
    
</script>


<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBtBfdvrpXq1tJSBGMEqziGOj2LFKsvSTQ",
        authDomain: "ages-cd6bc.firebaseapp.com",
        projectId: "ages-cd6bc",
        storageBucket: "ages-cd6bc.appspot.com",
        messagingSenderId: "800033951916",
        appId: "1:800033951916:web:9c97b66c162577998b0f09",
        measurementId: "G-2F3CSHCZZ7"
    };
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const database = firebase.database();
    
    async function fetchReferenceData(ref) {
        if (!ref) {
            console.error("Reference is undefined or null.");
            return {};
        }
        
        const doc = await ref.get();
        return doc.exists ? doc.data() : {};
    }
    
    
    function changeSVG(path, oldsvgId, divId) {
        const oldsvg = document.getElementById(oldsvgId);
        oldsvg.innerHTML = path;
    }
    
    function isLoading(a) {
        const element = document.getElementById("LastDriverElement");
        const loader = document.getElementById("LastDriverLoader");
        if (a === true) {
            loader.classList.add('flex');
            loader.classList.remove('hidden');
            element.classList.add('hidden');
            element.classList.remove('flex');
        } else {
            loader.classList.add('hidden');
            loader.classList.remove('flex');
            element.classList.add('flex');
            element.classList.remove('hidden');
        }
    }
    
    const svg_gateClose =  `
                <path d="M12 1a1 1 0 0 1 1 1v13h1.5a.5.5 0 0 1 0 1h-13a.5.5 0 0 1 0-1H3V2a1 1 0 0 1 1-1zm-2 9a1 1 0 1 0 0-2 1 1 0 0 0 0 2"/>
        `;
    const svg_gateOpen =  `
                <path d="M1.5 15a.5.5 0 0 0 0 1h13a.5.5 0 0 0 0-1H13V2.5A1.5 1.5 0 0 0 11.5 1H11V.5a.5.5 0 0 0-.57-.495l-7 1A.5.5 0 0 0 3 1.5V15zM11 2h.5a.5.5 0 0 1 .5.5V15h-1zm-2.5 8c-.276 0-.5-.448-.5-1s.224-1 .5-1 .5.448.5 1-.224 1-.5 1"/>
        `;
    const svg_obsClose =  `
                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                <path d="M11.354 4.646a.5.5 0 0 0-.708 0l-6 6a.5.5 0 0 0 .708.708l6-6a.5.5 0 0 0 0-.708"/>
        `;
    const svg_obsOpen =  `
                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                <path d="m10.97 4.97-.02.022-3.473 4.425-2.093-2.094a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05"/>        
        `;
    
    function getDriverDetails(lastname, firstname, datetime, plate, street){
        document.getElementById("current-driver-name").innerHTML = lastname+", "+firstname;
        document.getElementById("current-driver-plate").innerHTML = plate;
        document.getElementById("current-driver-date").innerHTML = datetime;
        document.getElementById("current-driver-street").innerHTML = street;
    }
    
    async function fetchReferenceData(ref) {
        const doc = await ref.get();
        return doc.exists ? doc.data() : {};
    }
    
    getLastDetectedDriver();
    
    async function getLastDetectedDriver() {
        isLoading(true);
        const querySnapshot = await db.collection("History")
        .orderBy("datetime", "desc")  // Order by datetime in descending order
        .limit(1)  // Get the most recent entry
        .get();
        
        if (!querySnapshot.empty) {
            const doc = querySnapshot.docs[0];  // Get the first document
            const data = doc.data();
            
            // Fetch vehicle data
            const vehicleData = await fetchReferenceData(data.vehicle);
            if (!vehicleData) {
                throw new Error("Vehicle data not found.");
            }
            
            // Fetch resident data
            const residentData = await fetchReferenceData(vehicleData.owner);
            if (!residentData) {
                throw new Error("Resident data not found.");
            }
            
            let accessStatus = data.entry ? 'Entry' : 'Exit';
            
            const lastname = residentData.lastName || 'N/A';  
            const firstname = residentData.firstName || 'N/A'; 
            const datetime = formatTimestamp(data.datetime) || 'N/A'; 
            const plate = vehicleData.licensePlate || 'N/A';  
            const street = residentData.street || 'N/A';  
            
            getDriverDetails(lastname, firstname, datetime, plate, street);
            isLoading(false);
            
        } else {
            console.log("No history found.");
        }
    }
    
    function formatTimestamp(timestamp) {
        if (!timestamp) return 'N/A';
        
        const date = timestamp.toDate();
        
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        
        return `${year}-${month}-${day} ${hours}:${minutes}`;
    }
    async function checkRFID(rfidUID) {
        try {
            const trimmedRfidUID = String(rfidUID).trim();;
            console.log("RFIDUID detected is: "+trimmedRfidUID);
            
            // Reference to the vehicle collection
            const vehicleRef = db.collection("Vehicle");
            
            
            // Query to f    the document where uid field matches rfidUID
            // const q = query(vehicleRef, where("uid", "==", trimmedRfidUID));
            const querySnapshot = await vehicleRef.where("uid", "==", trimmedRfidUID).get();
            // Execute the query
            // const querySnapshot = await getDocs(q);
            
            // Check if any document matches the query
            if (querySnapshot.empty) {
                console.log("No matching documents.");
                return false;
            } else {
                console.log("Document found!");
                querySnapshot.forEach(async (doc) => {
                    const data = doc.data();
                    const residentData = await fetchReferenceData(data.owner);
                    const lastname = residentData.lastName || 'N/A';  // Assuming the field is 'lastname'
                    const firstname = residentData.firstName || 'N/A';  // Assuming the field is 'firstname'
                    const today = new Date();
                    const datetime = data.datetime || today.toLocaleString();  // Assuming the field is 'datetime'
                    const plate = data.licensePlate || 'N/A';  // Assuming the field is 'plate'
                    const street = residentData.street || 'N/A';  // Assuming the field is 'street'
                    console.log(data.licensePlate);
                    
                    // Save to the History collection with the vehicle reference
                    const vehicleRefDoc = vehicleRef.doc(doc.id); // Get the reference path
                    
                    const historyQuerySnapshot = await db.collection("History")
                    .where("vehicle", "==", vehicleRefDoc)
                    .orderBy("datetime", "desc") // Get the most recent entry first
                    .limit(1) // Limit to one document
                    .get();
                    
                    let lastEntryType = null;
                    
                    // Check if there's any previous history for the vehicle
                    if (!historyQuerySnapshot.empty) {
                        const lastHistoryDoc = historyQuerySnapshot.docs[0];
                        lastEntryType = lastHistoryDoc.data().entry;  // Get the entry type of the last history record
                    }
                    
                    // Only save to History if the last entry is false or if there's no previous entry
                    if (lastEntryType === false || lastEntryType === null) {
                        await saveToHistory(vehicleRefDoc, true, true); // Save with the entry set to true
                        console.log("Last history is exit, saving as entry");
                    } else {
                        await saveToHistory(vehicleRefDoc, true, false); // Save with the entry set to true
                        console.log("Last history is entry, saving as exit");
                    }
                });
                return true;
            }
        } catch (error) {
            console.error("Error checking RFID in database:", error);
        }
    }
    async function saveToHistory(vehicleRef, isResident, entry) {
        const historyRef = db.collection("History");
        
        const historyData = {
            datetime: new Date(),  // Set to the current date and time
            entry: entry,          // Set to true or false based on your application logic
            isResident: isResident, // True if the person is a resident, else false
            vehicle: vehicleRef    // Reference to the vehicle
        };
        
        try {
            await historyRef.add(historyData);
            console.log("History record added successfully:", historyData);
        } catch (error) {
            console.error("Error saving to History collection:", error);
        }
    }
</script>

<script>
    
    const statusInfo = document.getElementById('status-info');
    const statusIcons = document.getElementById('status-icons');
    const iconBox  = document.getElementsByClassName('icon-clickable');
    const alertBox = document.getElementById('alert-box');
    let closeAlertTimeOut;
    
    Array.from(iconBox).forEach(element => {
        element.addEventListener('click', () => {
            let gatePositionText = document.getElementById('icon-label-gate').textContent;
            const ButtonId = element.id;
            console.log(`Clicked element ID: ${ButtonId}`);
            if (ButtonId == "gate-position") {
                console.log(`gate-position: ` + gatePositionText);
                if (gatePositionText.toUpperCase() === "OPEN") {
                    console.log(`Requesting gate to close.`);
                    processGatePosition("0");  // Command to close the gate
                } else if (gatePositionText.toUpperCase() === "CLOSED") {
                    console.log(`Requesting gate to open.`);
                    processGatePosition("1");  // Command to open the gate
                }
                
            }
            //alerted
            // if (alertBox.classList.contains('hidden')) {
            //     alertBox.classList.remove('hidden');
            
            //     const progressBar = document.getElementById('progress-bar');
            //     progressBar.style.width = '0%';
            
            //     setTimeout(() => {
            //         progressBar.style.width = '100%';
            //     }, 10); 
            
            //     closeAlertTimeOut = setTimeout(() => {
            //         alertBox.classList.add('hidden');
            //     }, 5000);
            // }
        });
    });
    
</script>
<script>
    
    async function addResident() {
        // Gather input values
        const lastName = document.getElementById('modal-addr-last-name').value;
        const firstName = document.getElementById('modal-addr-first-name').value;
        const middleInitial = document.getElementById('modal-addr-middle-initial').value;
        const street = document.getElementById('modal-addr-street').value;
        const block = document.getElementById('modal-addr-block').value;
        const lot = document.getElementById('modal-addr-lot').value;
        
        if (!lastName || !firstName || !middleInitial || !street || !block || !lot) {
            alert("Please fill in all fields.");
            return; // Exit the function if any field is empty
        }
        
        // Create the resident data object
        const residentData = {
            archived: false, // Setting archived to false
            block: block,
            datetimeAdded: new Date(), // Current date and time as timestamp
            firstName: firstName,
            lastName: lastName,
            lot: lot,
            middleName: middleInitial,
            street: street,
        };
        
        // Add the resident data to the 'Residents' collection in Firestore
        try {
            await db.collection('Residents').add(residentData);
            alert("Resident added successfully!");
            // Optionally, reset the input fields
            resetForm();
        } catch (error) {
            console.error("Error adding resident: ", error);
            alert("Error adding resident: " + error.message);
        }
    }
    
    function resetForm() {
        document.getElementById('modal-addr-last-name').value = '';
        document.getElementById('modal-addr-first-name').value = '';
        document.getElementById('modal-addr-middle-initial').value = '';
        document.getElementById('modal-addr-street').value = '';
        document.getElementById('modal-addr-block').value = '';
        document.getElementById('modal-addr-lot').value = '';
    }
</script>

<script>
    
    async function visitorList() {
        const visitlist = document.getElementById('visitlist');
        visitlist.innerHTML = "";
        
        try {
            const querySnapshot = await db.collection("Visitors")
            .orderBy("entrydate", "desc")
            .get();
            
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                if (!data.exitdate) {
                    const listItem = document.createElement('li');
                    listItem.textContent = data.physical_visitor_id || 'N/A';
                    listItem.style.cursor = 'pointer';
                    
                    listItem.addEventListener('click', () => showVisitorDetails(data));
                    visitlist.appendChild(listItem);
                }
            });
        } catch (error) {
            console.error("Error fetching visitor list:", error);
        }
    }
    
    function showVisitorDetails(data) {
        const entryDate = data.entrydate ? data.entrydate.toDate().toLocaleString('en-US', { 
            timeZone: 'Asia/Manila', 
            dateStyle: 'long', 
            timeStyle: 'medium' 
        }) : 'N/A';
        document.getElementById('modal-visitorid').textContent = data.physical_visitor_id;
        document.getElementById('modal-visitorentry').textContent = entryDate || 'N/A';
        document.getElementById('modal-visitorexit').textContent = data.exitdate || 'N/A';
        document.getElementById('modal-visitorvbrand').textContent = data.vBrand || 'N/A';
        document.getElementById('modal-visitorvtype').textContent = data.vType || 'N/A';
        
        document.getElementById('visitorInfoModal').style.display = 'flex';
    }
    
    function closeVisitorInfoModal() {
        document.getElementById('visitorInfoModal').style.display = 'none';
    }
    
    visitorList();
    
    function addVisitor(){
        const visitorid = document.getElementById('visitor-number').value;
        const vehicleType = document.getElementById('vehicle-type').value;
        const vehicleBrand = document.getElementById('vehicle-brand').value;
        const idimage = document.getElementById('visitorimage').value;
        
        if (!visitorid || !vehicleType || !vehicleBrand) {
            alert("Please fill in all fields.");
            return; // Exit the function if any field is empty
        }
        
        const VisitorData = {
            entrydate: firebase.firestore.FieldValue.serverTimestamp(),
            personal_id: idimage, 
            physical_visitor_id: visitorid,
            vBrand: vehicleBrand,
            vType: vehicleType
        }
        db.collection('Visitors').add(VisitorData)
        .then(() => {
            alert("Vehicle added successfully!");
            document.getElementById('visitor-number').value = '';   // Clear license plate field
            document.getElementById('vehicle-type').selectedIndex = 0; // Reset vehicle type dropdown
            document.getElementById('vehicle-brand').selectedIndex = 0; // Reset vehicle brand dropdown
            modalOpen('main');
        })
        .catch((error) => {
            alert("Error adding vehicle: ", error);
        });
        
    }
    
    async function deleteVisitor() {
        const visitorId = document.getElementById('modal-visitorid').textContent;
        const exitDate = firebase.firestore.FieldValue.serverTimestamp(); // Set exit date to current timestamp
        
        try {
            // Find the document in Firestore using the visitor ID (assuming physical_visitor_id is the identifier)
            const querySnapshot = await db.collection("Visitors").where("physical_visitor_id", "==", visitorId).get();
            
            querySnapshot.forEach(async (doc) => {
                await doc.ref.update({ exitdate: exitDate }); // Update the exit date in the document
                alert("Visitor exited successfully!"); // Notify the user
                
                // Close the modal
                closeVisitorInfoModal();
                
                // Refresh the visitor list
                visitorList();
            });
        } catch (error) {
            console.error("Error deleting visitor:", error);
            alert("Failed to delete visitor.");
        }
    }

</script>
<script>
    function openAdminLoginModal() {
        document.getElementById('adminLoginModal').style.display = 'flex';
    }

    function closeAdminLoginModal() {
        document.getElementById('adminLoginModal').style.display = 'none';
    }

    function checkAdminAccess() {
    const isAdmin = sessionStorage.getItem('isAdmin');

    if (isAdmin) {
        // If the user is an admin, show the buttons
        document.getElementById('manageResidentsButton').style.display = 'inline-block';
        document.getElementById('manageVehiclesButton').style.display = 'inline-block';
        document.getElementById('LoginAsAdmin').style.display = 'none'; // Ensure this hides the button
    } else {
        document.getElementById('LoginAsAdmin').style.display = 'flex';
    }
}

    async function adminLogin() {
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;

        try {
            const querySnapshot = await db.collection("Accounts")
                .where("username", "==", username)
                .where("password", "==", password)
                .get();

            if (!querySnapshot.empty) {
                sessionStorage.setItem('isAdmin', 'true');
                closeAdminLoginModal();
                location.reload();
            } else {
                alert("Invalid credentials. Please try again.");
            }
        } catch (error) {
            console.error("Error checking admin credentials:", error);
        }
    }

    window.onload = function() {
        checkAdminAccess();
    };
</script>

</html>
